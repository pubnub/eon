<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>Flights in SFO Area</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
      }
    </style>

    <link href="./lib/mapbox.css" rel="stylesheet" />
    <script src="./lib/mapbox.js"></script>

    <script src="./bower_components/pubnub/web/pubnub.min.js"></script>
    <script src="./pubnub-mapbox.js"></script>

  </head>
  <body>
    <div id='map'></div>
    <script>


      L.RotatedMarker = L.Marker.extend({
        options: { angle: 0 },
        _setPos: function(pos) {
          L.Marker.prototype._setPos.call(this, pos);
          if (L.DomUtil.TRANSFORM) {
            // use the CSS transform rule if available
            this._icon.style[L.DomUtil.TRANSFORM] += ' rotate(' + this.options.angle + 'deg)';
          } else if (L.Browser.ie) {
            // fallback for IE6, IE7, IE8
            var rad = this.options.angle * L.LatLng.DEG_TO_RAD,
            costheta = Math.cos(rad),
            sintheta = Math.sin(rad);
            this._icon.style.filter += ' progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\', M11=' +
              costheta + ', M12=' + (-sintheta) + ', M21=' + sintheta + ', M22=' + costheta + ')';
          }

        }
      });

      var map = eon.map({
        id: 'map',
        mb_id: 'ianjennings.lec06po7',
        mb_token: 'pk.eyJ1IjoiaWFuamVubmluZ3MiLCJhIjoiZExwb0p5WSJ9.XLi48h-NOyJOCJuu1-h-Jg',
        channel: 'sfo-flight-data',
        rotate: true,
        history: true,
        marker: function (latlng, data) {

          var marker = new L.RotatedMarker(latlng, {
            icon: L.icon({
              iconUrl: 'https://www.mapbox.com/maki/renders/airport-24@2x.png',
              iconSize: [24, 24]
            })
          });

          var popup = '';
          if(data[13]) {
            popup = 'Flight <strong>' + data[13] + '</strong>';
          }
          if(data[11]) {
            if(!popup.length) {
              popup = 'Flight from ' + data[11];
            } else {
              popup += ' from ' + data[11];
            }
          }
          if(data[12]) {
            if(!popup.length) {
              popup = 'Flight to ' + data[11];
            } else {
              popup += ' to ' + data[11];
            }
          }
          if(!popup.length) {
            var popup = 'No data available';
          }

          marker.bindPopup(popup);

          return marker;
        }
      });
    </script>
  </body>
</html>